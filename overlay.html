<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Honolulu Marathon 2025 Overlay</title>
  <style>
    :root{
      --h: 120px; --pad: 16px;
      --gap: 6px; --radius: 10px;
      --panel: rgba(0,0,0,0.55);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --segOff: rgba(255,255,255,0.16);
      --segOn: rgba(255,255,255,0.92);
      --glow: rgba(255, 220, 120, 0.55);
    }
    html, body { margin:0; padding:0; background:rgba(0,0,0,0); overflow:hidden;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); }
    #overlay { position:fixed; left:0; right:0; bottom:0; height:var(--h);
      display:flex; align-items:flex-end; justify-content:center; pointer-events:none; }
    #panel { width:calc(100% - (var(--pad)*2)); margin-bottom:var(--pad);
      padding:12px 12px 10px 12px; border-radius:16px; background:var(--panel);
      box-shadow:0 10px 30px rgba(0,0,0,0.35); position:relative; overflow:hidden; }
    #panel::after{ content:""; position:absolute; inset:-60px -120px auto -120px; height:120px;
      transform:rotate(10deg); background:linear-gradient(90deg,transparent,rgba(255,255,255,0.10),transparent);
      animation:sheen 6s linear infinite; opacity:0.35; }
    @keyframes sheen{ 0%{transform:translateX(-40%) rotate(10deg);} 100%{transform:translateX(140%) rotate(10deg);} }

    #toprow{ display:flex; justify-content:space-between; align-items:baseline; gap:12px; margin-bottom:8px; position:relative; z-index:2; }
    #title{ font-weight:800; letter-spacing:0.8px; font-size:16px; white-space:nowrap; text-transform:uppercase; }
    #readout{ font-weight:800; font-size:16px; white-space:nowrap; }
    #readout span{ color:var(--muted); font-weight:700; margin-left:8px; font-size:13px; }

    #segments{ display:flex; gap:var(--gap); width:100%; align-items:stretch; position:relative; z-index:2; }
    .seg{ flex:1; height:22px; border-radius:var(--radius); background:var(--segOff); position:relative; overflow:hidden; }
    .seg.last{ flex:1.2; }
    .fill{ position:absolute; inset:0; width:0%; background:var(--segOn); border-radius:var(--radius); transition:width 220ms ease; }

    .pulse{ animation:pulse 650ms ease-out; }
    @keyframes pulse{ 0%{box-shadow:0 10px 30px rgba(0,0,0,0.35);} 35%{box-shadow:0 12px 40px var(--glow);} 100%{box-shadow:0 10px 30px rgba(0,0,0,0.35);} }

    #finish{ position:absolute; inset:10px 12px auto 12px; padding:10px 12px; border-radius:14px;
      background:rgba(0,0,0,0.62); border:1px solid rgba(255,255,255,0.20);
      display:none; align-items:center; justify-content:space-between; gap:10px; z-index:4; }
    #finish b{ font-size:16px; letter-spacing:0.8px; }
    #finish .tag{ font-size:13px; font-weight:800; padding:6px 10px; border-radius:999px;
      background:linear-gradient(90deg,rgba(255,255,255,0.95),rgba(255,215,140,0.95));
      color:rgba(0,0,0,0.85); box-shadow:0 10px 30px rgba(0,0,0,0.25); }
    .finishOn{ display:flex !important; animation:finishPop 900ms ease-out; box-shadow:0 16px 50px rgba(255,220,120,0.25); }
    @keyframes finishPop{ 0%{transform:translateY(10px) scale(0.98);opacity:0;} 35%{transform:translateY(0) scale(1.02);opacity:1;} 100%{transform:translateY(0) scale(1);opacity:1;} }

    #mileChip{ position:absolute; right:12px; bottom:42px; padding:8px 12px; border-radius:999px;
      background:rgba(0,0,0,0.62); border:1px solid rgba(255,255,255,0.18);
      display:none; align-items:center; gap:8px; z-index:5; box-shadow:0 16px 50px rgba(0,0,0,0.22); backdrop-filter:blur(6px); }
    #mileChip .dot{ width:10px; height:10px; border-radius:999px; background:rgba(255,255,255,0.92);
      box-shadow:0 0 0 6px rgba(255,220,120,0.12); }
    #mileChip .txt{ font-weight:900; letter-spacing:0.5px; font-size:13px; text-transform:uppercase; white-space:nowrap; }
    .chipOn{ display:flex !important; animation:chipPop 1500ms ease-out; }
    @keyframes chipPop{ 0%{transform:translateY(8px) scale(0.98);opacity:0;} 18%{transform:translateY(0) scale(1.02);opacity:1;}
      70%{transform:translateY(0) scale(1);opacity:1;} 100%{transform:translateY(-6px) scale(0.98);opacity:0;} }

    @media (max-width: 900px){
      #title,#readout{ font-size:15px; }
      .seg{ height:20px; }
      #mileChip{ bottom:40px; }
    }
  </style>
</head>
<body>
  <div id="overlay">
    <div id="panel">
      <div id="finish">
        <b>FINISHED ‚Ä¢ 26.2 MILES</b>
        <div class="tag">üèÅ HONOLULU MARATHON 2025</div>
      </div>

      <div id="mileChip">
        <div class="dot"></div>
        <div class="txt" id="mileChipText">MILE 1!</div>
      </div>

      <div id="toprow">
        <div id="title">HONOLULU MARATHON 2025</div>
        <div id="readout"><b id="milesText">0.0</b> mi <span id="pctText">0%</span></div>
      </div>

      <div id="segments"></div>
    </div>
  </div>

  <!-- Firebase SDKs (compat builds for simplest copy/paste) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <script>
    // 1) Paste your Firebase web config here (from Project Settings ‚Üí Your apps)
   // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyC5jx_D-VqD6Rgk-n9VLupGyG2y3wJS_nQ",
  authDomain: "brad-marathon-tracker.firebaseapp.com",
  databaseURL: "https://brad-marathon-tracker-default-rtdb.firebaseio.com",
  projectId: "brad-marathon-tracker",
  storageBucket: "brad-marathon-tracker.firebasestorage.app",
  messagingSenderId: "803278898242",
  appId: "1:803278898242:web:ab632539fa7f6c690699db",
  measurementId: "G-QCHWN501XC"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const SEGMENTS = [...Array.from({ length: 25 }, () => 1.0), 1.2];
    const TOTAL = 26.2;

    const panel = document.getElementById('panel');
    const finish = document.getElementById('finish');
    const mileChip = document.getElementById('mileChip');
    const mileChipText = document.getElementById('mileChipText');
    const elSegments = document.getElementById('segments');
    const elMilesText = document.getElementById('milesText');
    const elPctText = document.getElementById('pctText');

    const segEls = SEGMENTS.map((len, i) => {
      const seg = document.createElement('div');
      seg.className = 'seg' + (i === SEGMENTS.length - 1 ? ' last' : '');
      const fill = document.createElement('div');
      fill.className = 'fill';
      seg.appendChild(fill);
      elSegments.appendChild(seg);
      return { fill, len };
    });

    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

    function setDynamicColor(progress01){
      const t = clamp((progress01 - 0.60) / 0.40, 0, 1);
      const r = 255;
      const g = Math.round(255 + (215 - 255) * t);
      const b = Math.round(255 + (140 - 255) * t);
      const a = 0.92;
      document.documentElement.style.setProperty('--segOn', `rgba(${r},${g},${b},${a})`);
      const glowA = 0.40 + 0.25 * t;
      document.documentElement.style.setProperty('--glow', `rgba(255,220,120,${glowA})`);
      const dot = mileChip.querySelector('.dot');
      if (dot) dot.style.background = `rgba(${r},${g},${b},${a})`;
    }

    function render(miles){
      const m = clamp(Number(miles) || 0, 0, TOTAL);
      const pct = (m / TOTAL) * 100;

      elMilesText.textContent = m.toFixed(1);
      elPctText.textContent = `${pct.toFixed(0)}%`;

      setDynamicColor(m / TOTAL);

      let remaining = m;
      for (const s of segEls){
        const segDone = clamp(remaining / s.len, 0, 1);
        s.fill.style.width = `${(segDone * 100).toFixed(2)}%`;
        remaining -= s.len;
      }

      if (m >= TOTAL - 1e-6) finish.classList.add('finishOn');
      else finish.classList.remove('finishOn');
    }

    function triggerPulse(){
      panel.classList.remove('pulse');
      void panel.offsetWidth;
      panel.classList.add('pulse');
    }

    let chipTimer = null;
    function showMileChip(mileNumber){
      mileChipText.textContent = `MILE ${mileNumber}!`;
      mileChip.classList.remove('chipOn');
      void mileChip.offsetWidth;
      mileChip.classList.add('chipOn');

      if (chipTimer) clearTimeout(chipTimer);
      chipTimer = setTimeout(() => mileChip.classList.remove('chipOn'), 1600);
    }

    let lastMiles = null;
    let lastWhole = 0;

    // ‚úÖ Real-time listener: updates instantly (no polling)
    db.ref('state/miles').on('value', (snap) => {
      const miles = Number(snap.val());
      if (!isFinite(miles)) return;

      if (miles !== lastMiles){
        const whole = Math.floor(miles + 1e-9);
        if (whole > lastWhole && whole >= 1 && whole <= 26){
          triggerPulse();
          showMileChip(whole);
        }
        lastWhole = whole;
        lastMiles = miles;
        render(miles);
      }
    });

    render(0);
  </script>
</body>
</html>
